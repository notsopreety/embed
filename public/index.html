<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HLS Video Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #0a0a0a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #fff;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      color: #e0e0e0;
    }
    .player-container {
      width: 100%;
      max-width: 900px;
      background: #111;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    video {
      width: 100%;
      display: block;
      background: #000;
    }
    .controls {
      padding: 15px;
      background: #1a1a1a;
    }
    .subtitle-select {
      width: 100%;
      padding: 10px;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .subtitle-select:focus {
      outline: none;
      border-color: #666;
    }
    .status {
      margin-top: 15px;
      padding: 10px 15px;
      background: #1a1a1a;
      border-radius: 8px;
      font-size: 13px;
      color: #888;
    }
  </style>
</head>
<body>
  <h1>Solo Leveling - Episode Player</h1>
  
  <div class="player-container">
    <video id="video" controls crossorigin="anonymous"></video>
    <div class="controls">
      <select id="subtitleSelect" class="subtitle-select">
        <option value="">Select Subtitle</option>
      </select>
    </div>
  </div>
  
  <div id="status" class="status">Loading stream data...</div>

  <script>
    const video = document.getElementById('video');
    const subtitleSelect = document.getElementById('subtitleSelect');
    const statusEl = document.getElementById('status');
    let hls = null;
    let streamData = null;

    function proxyUrl(url) {
      if (url.startsWith('/proxy?url=')) {
        return url;
      }
      return '/proxy?url=' + encodeURIComponent(url);
    }

    async function init() {
      try {
        const response = await fetch('/api/stream');
        const result = await response.json();
        
        if (!result.success) {
          statusEl.textContent = 'Failed to load stream data';
          return;
        }
        
        streamData = result.data;
        const hlsUrl = streamData.link.file;
        
        console.log('HLS URL:', hlsUrl);
        
        streamData.tracks.filter(t => t.kind === 'captions').forEach(track => {
          const option = document.createElement('option');
          option.value = track.file;
          option.textContent = track.label + (track.default ? ' (Default)' : '');
          subtitleSelect.appendChild(option);
        });
        
        if (Hls.isSupported()) {
          hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: false,
            manifestLoadPolicy: {
              default: {
                maxTimeToFirstByteMs: 10000,
                maxLoadTimeMs: 20000,
                timeoutRetry: { maxNumRetry: 3, retryDelayMs: 0, maxRetryDelayMs: 0 },
                errorRetry: { maxNumRetry: 3, retryDelayMs: 1000, maxRetryDelayMs: 8000 }
              }
            },
            playlistLoadPolicy: {
              default: {
                maxTimeToFirstByteMs: 10000,
                maxLoadTimeMs: 20000,
                timeoutRetry: { maxNumRetry: 3, retryDelayMs: 0, maxRetryDelayMs: 0 },
                errorRetry: { maxNumRetry: 3, retryDelayMs: 1000, maxRetryDelayMs: 8000 }
              }
            },
            fragLoadPolicy: {
              default: {
                maxTimeToFirstByteMs: 10000,
                maxLoadTimeMs: 120000,
                timeoutRetry: { maxNumRetry: 4, retryDelayMs: 0, maxRetryDelayMs: 0 },
                errorRetry: { maxNumRetry: 6, retryDelayMs: 1000, maxRetryDelayMs: 8000 }
              }
            }
          });
          
          hls.loadSource(proxyUrl(hlsUrl));
          hls.attachMedia(video);
          
          hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
            statusEl.textContent = `Stream loaded - ${data.levels.length} quality levels available`;
            video.play().catch(() => {});
          });
          
          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS Error:', data);
            if (data.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  statusEl.textContent = 'Network error - trying to recover...';
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  statusEl.textContent = 'Media error - trying to recover...';
                  hls.recoverMediaError();
                  break;
                default:
                  statusEl.textContent = 'Fatal error: ' + data.details;
                  hls.destroy();
                  break;
              }
            }
          });

          hls.on(Hls.Events.FRAG_LOADED, () => {
            if (statusEl.textContent.includes('trying') || statusEl.textContent.includes('Loading')) {
              statusEl.textContent = 'Playing...';
            }
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = proxyUrl(hlsUrl);
          statusEl.textContent = 'Using native HLS support';
        } else {
          statusEl.textContent = 'HLS not supported in this browser';
        }
        
      } catch (error) {
        console.error('Init error:', error);
        statusEl.textContent = 'Error: ' + error.message;
      }
    }

    subtitleSelect.addEventListener('change', () => {
      const existingTracks = video.querySelectorAll('track');
      existingTracks.forEach(t => t.remove());
      
      if (subtitleSelect.value) {
        const track = document.createElement('track');
        track.kind = 'subtitles';
        track.src = proxyUrl(subtitleSelect.value);
        track.srclang = 'en';
        track.label = subtitleSelect.options[subtitleSelect.selectedIndex].text;
        track.default = true;
        video.appendChild(track);
        track.track.mode = 'showing';
      }
    });

    init();
  </script>
</body>
</html>
