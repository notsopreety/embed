<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Video Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .player-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
    }

    video {
      width: 100%;
      height: 100%;
      background: #000;
    }

    ::cue {
      background-image: linear-gradient(to bottom, transparent, transparent);
      background-color: var(--cc-bg-color, transparent);
      color: var(--cc-text-color, white);
      font-family: var(--cc-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif);
      font-size: var(--cc-font-size, 1.2em);
      font-weight: 600;
      opacity: var(--cc-text-opacity, 1);
      text-shadow: 
        -2px -2px 0 rgba(0, 0, 0, 0.9),
        2px -2px 0 rgba(0, 0, 0, 0.9),
        -2px 2px 0 rgba(0, 0, 0, 0.9),
        2px 2px 0 rgba(0, 0, 0, 0.9),
        0 -2px 0 rgba(0, 0, 0, 0.9),
        0 2px 0 rgba(0, 0, 0, 0.9),
        -2px 0 0 rgba(0, 0, 0, 0.9),
        2px 0 0 rgba(0, 0, 0, 0.9),
        -3px 0 5px rgba(0, 0, 0, 0.85),
        3px 0 5px rgba(0, 0, 0, 0.85),
        0 -3px 5px rgba(0, 0, 0, 0.85),
        0 3px 5px rgba(0, 0, 0, 0.85);
      line-height: 1.4;
      letter-spacing: 0.5px;
      text-align: center;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    ::cue-background {
      background: transparent;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: #e50914;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #fff;
      margin-top: 15px;
      font-size: 14px;
    }

    .error-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      color: #fff;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .error-text {
      font-size: 16px;
      text-align: center;
      max-width: 80%;
    }

    .controls-wrapper {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
      padding: 60px 12px 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 50;
    }

    .player-wrapper:hover .controls-wrapper,
    .player-wrapper.show-controls .controls-wrapper {
      opacity: 1;
    }

    .progress-container {
      position: relative;
      width: 100%;
      height: 5px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .progress-container:hover {
      height: 7px;
    }

    .progress-buffered {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 3px;
      pointer-events: none;
    }

    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: #e50914;
      border-radius: 3px;
      pointer-events: none;
    }

    .progress-handle {
      position: absolute;
      top: 50%;
      width: 14px;
      height: 14px;
      background: #e50914;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .progress-container:hover .progress-handle {
      opacity: 1;
    }

    .thumbnail-preview {
      position: absolute;
      bottom: 40px;
      background: rgba(20, 20, 20, 0.95);
      border: 2px solid #e50914;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8), 0 0 20px rgba(229, 9, 20, 0.2);
      padding: 0;
      overflow: hidden;
      z-index: 100;
    }

    .thumbnail-sprite {
      background-size: auto;
      background-repeat: no-repeat;
      background-position: 0 0;
      background-color: transparent;
      display: block;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }

    .thumbnail-time {
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.9);
      width: 100%;
      text-align: center;
      border-top: 1px solid rgba(229, 9, 20, 0.3);
      letter-spacing: 0.5px;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .control-btn {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .control-btn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .volume-slider {
      width: 0;
      overflow: hidden;
      transition: width 0.2s;
    }

    .volume-container:hover .volume-slider {
      width: 80px;
    }

    .volume-slider input {
      width: 80px;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      cursor: pointer;
    }

    .volume-slider input::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
    }

    .volume-slider input::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .time-display {
      color: #fff;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
      user-select: none;
    }

    .spacer {
      flex: 1;
    }

    .settings-container {
      position: relative;
    }

    .settings-menu {
      position: absolute;
      bottom: 50px;
      right: 0;
      background: rgba(28, 28, 28, 0.95);
      border-radius: 8px;
      min-width: 280px;
      max-height: 400px;
      display: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      flex-direction: column;
    }

    .settings-menu.show {
      display: flex;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .settings-tabs {
      display: flex;
      gap: 0;
      padding: 0;
    }

    .settings-tab-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      padding: 8px 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      position: relative;
    }

    .settings-tab-btn:hover {
      color: #fff;
    }

    .settings-tab-btn.active {
      color: #e50914;
    }

    .settings-tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e50914;
    }

    .settings-content {
      overflow-y: auto;
      max-height: 320px;
      padding: 0;
    }

    .settings-section {
      display: none;
    }

    .settings-section.active {
      display: block;
    }

    .settings-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
      transition: background 0.2s;
    }

    .settings-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .settings-option.active {
      color: #e50914;
    }

    .settings-option .check {
      opacity: 0;
    }

    .settings-option.active .check {
      opacity: 1;
    }

    .cc-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .cc-modal-overlay.show {
      display: flex;
    }

    .cc-modal {
      background: rgba(40, 40, 50, 0.98);
      border-radius: 12px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
    }

    .cc-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cc-modal-title {
      color: #fff;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .cc-modal-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }

    .cc-modal-close:hover {
      color: #e50914;
    }

    .cc-preview {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(229, 9, 20, 0.3);
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 25px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--cc-font-size, 18px);
      color: var(--cc-text-color, white);
      font-family: var(--cc-font-family, Arial);
      opacity: var(--cc-text-opacity, 1);
    }

    .cc-controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .cc-control-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .cc-control-label {
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.9;
    }

    .cc-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .cc-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e50914;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(229, 9, 20, 0.5);
    }

    .cc-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e50914;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 8px rgba(229, 9, 20, 0.5);
    }

    .cc-slider-value {
      color: #e50914;
      font-size: 12px;
      font-weight: 600;
    }

    .cc-color-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .cc-color-btn {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .cc-color-btn:hover {
      border-color: rgba(255, 255, 255, 0.3);
    }

    .cc-color-btn.active {
      border-color: #e50914;
      box-shadow: 0 0 8px rgba(229, 9, 20, 0.5);
    }

    .cc-dropdown {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .cc-dropdown:hover {
      border-color: rgba(255, 255, 255, 0.4);
    }

    .cc-dropdown:focus {
      outline: none;
      border-color: #e50914;
    }

    .cc-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cc-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cc-btn-reset {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .cc-btn-reset:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .cc-btn-save {
      background: #e50914;
      color: #fff;
    }

    .cc-btn-save:hover {
      background: #cc070b;
      box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
    }

    .audio-toggle {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .audio-toggle button {
      background: none;
      border: none;
      color: #fff;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .audio-toggle button.active {
      background: #e50914;
    }

    .audio-toggle button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.2);
    }

    .top-gradient {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(rgba(0, 0, 0, 0.7), transparent);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 30;
      pointer-events: none;
    }

    .player-wrapper:hover .top-gradient,
    .player-wrapper.show-controls .top-gradient {
      opacity: 1;
    }

    .double-tap-overlay {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 40%;
      z-index: 35;
    }

    .double-tap-overlay.left {
      left: 0;
    }

    .double-tap-overlay.right {
      right: 0;
    }

    .center-controls {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      gap: 40px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 40;
    }

    .player-wrapper:hover .center-controls,
    .player-wrapper.show-controls .center-controls {
      opacity: 1;
    }

    .center-btn {
      background: rgba(0, 0, 0, 0.6);
      border: none;
      color: #fff;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, background 0.2s;
    }

    .center-btn:hover {
      transform: scale(1.1);
      background: rgba(0, 0, 0, 0.8);
    }

    .center-btn.main {
      width: 80px;
      height: 80px;
    }

    .center-btn svg {
      width: 32px;
      height: 32px;
      fill: currentColor;
    }

    .center-btn.main svg {
      width: 40px;
      height: 40px;
    }

    .skip-button {
      position: absolute;
      bottom: 100px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: none;
      z-index: 60;
      transition: background 0.2s;
    }

    .skip-button:hover {
      background: #fff;
    }

    .skip-button.show {
      display: block;
    }

    .seek-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 15px 25px;
      border-radius: 8px;
      font-size: 18px;
      display: none;
      z-index: 70;
    }

    .seek-indicator.left {
      left: 20%;
    }

    .seek-indicator.right {
      right: 20%;
    }

    @media (max-width: 1200px) {
      .thumbnail-preview {
        bottom: 35px;
      }
    }

    @media (max-width: 768px) {
      .thumbnail-preview {
        bottom: 30px;
        border-width: 2px;
      }

      .thumbnail-time {
        font-size: 12px;
        padding: 5px 10px;
      }
      
      .controls-wrapper {
        padding: 40px 8px 8px;
      }

      .control-btn svg {
        width: 20px;
        height: 20px;
      }

      .center-btn {
        width: 50px;
        height: 50px;
      }

      .center-btn.main {
        width: 65px;
        height: 65px;
      }

      .center-btn svg {
        width: 24px;
        height: 24px;
      }

      .center-btn.main svg {
        width: 32px;
        height: 32px;
      }

      .time-display {
        font-size: 11px;
      }

      .volume-container:hover .volume-slider {
        width: 60px;
      }

      .skip-button {
        bottom: 80px;
        right: 10px;
        padding: 8px 16px;
        font-size: 12px;
      }

      .controls-row {
        gap: 8px;
      }
    }

    @media (max-width: 600px) {
      .thumbnail-preview {
        bottom: 25px;
        max-width: 90vw;
      }

      .thumbnail-time {
        font-size: 11px;
        padding: 4px 8px;
      }

      .audio-toggle button {
        padding: 5px 10px;
        font-size: 11px;
      }

      .time-display {
        font-size: 10px;
      }

      .center-btn {
        width: 45px;
        height: 45px;
      }

      .center-btn.main {
        width: 60px;
        height: 60px;
      }

      .center-btn svg {
        width: 20px;
        height: 20px;
      }

      .center-btn.main svg {
        width: 28px;
        height: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="player-wrapper" id="playerWrapper">
    <div class="top-gradient"></div>

    <video id="video" playsinline crossorigin="anonymous"></video>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>

    <div class="error-overlay" id="errorOverlay">
      <div class="error-icon">⚠️</div>
      <div class="error-text" id="errorText">Failed to load video</div>
    </div>

    <div class="double-tap-overlay left" id="doubleTapLeft"></div>
    <div class="double-tap-overlay right" id="doubleTapRight"></div>

    <div class="seek-indicator left" id="seekLeft">
      <span>-10s</span>
    </div>
    <div class="seek-indicator right" id="seekRight">
      <span>+10s</span>
    </div>

    <div class="center-controls" id="centerControls">
      <button class="center-btn" id="rewindBtn" title="Rewind 10s">
        <svg viewBox="0 0 24 24"><path d="M12.5 3C17.15 3 21.08 6.03 22.47 10.22L20.1 11C19.05 7.81 16.04 5.5 12.5 5.5C10.54 5.5 8.77 6.22 7.38 7.38L10 10H3V3L5.6 5.6C7.45 4 9.85 3 12.5 3M10 12V22H8V14H6V12H10M18 14V20C18 21.11 17.11 22 16 22H14C12.9 22 12 21.1 12 20V14C12 12.9 12.9 12 14 12H16C17.11 12 18 12.9 18 14M14 14V20H16V14H14Z"/></svg>
      </button>
      <button class="center-btn main" id="playPauseMain" title="Play/Pause">
        <svg viewBox="0 0 24 24" class="play-icon"><path d="M8 5v14l11-7z"/></svg>
        <svg viewBox="0 0 24 24" class="pause-icon" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </button>
      <button class="center-btn" id="forwardBtn" title="Forward 10s">
        <svg viewBox="0 0 24 24"><path d="M11.5 3C6.85 3 2.92 6.03 1.53 10.22L3.9 11C4.95 7.81 7.96 5.5 11.5 5.5C13.46 5.5 15.23 6.22 16.62 7.38L14 10H21V3L18.4 5.6C16.55 4 14.15 3 11.5 3M10 12V22H8V14H6V12H10M18 14V20C18 21.11 17.11 22 16 22H14C12.9 22 12 21.1 12 20V14C12 12.9 12.9 12 14 12H16C17.11 12 18 12.9 18 14M14 14V20H16V14H14Z"/></svg>
      </button>
    </div>

    <button class="skip-button" id="skipIntro">Skip Intro</button>
    <button class="skip-button" id="skipOutro" style="display:none">Skip Outro</button>

    <div class="controls-wrapper" id="controlsWrapper">
      <div class="progress-container" id="progressContainer">
        <div class="progress-buffered" id="progressBuffered"></div>
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-handle" id="progressHandle"></div>
        <div class="thumbnail-preview" id="thumbnailPreview">
          <div id="thumbnailImg" class="thumbnail-sprite"></div>
          <div class="thumbnail-time" id="thumbnailTime">0:00</div>
        </div>
      </div>

      <div class="controls-row">
        <button class="control-btn" id="playPauseBtn" title="Play/Pause (Space)">
          <svg viewBox="0 0 24 24" class="play-icon"><path d="M8 5v14l11-7z"/></svg>
          <svg viewBox="0 0 24 24" class="pause-icon" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>

        <div class="volume-container">
          <button class="control-btn" id="volumeBtn" title="Mute (M)">
            <svg viewBox="0 0 24 24" class="volume-high"><path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>
            <svg viewBox="0 0 24 24" class="volume-muted" style="display:none"><path d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z"/></svg>
          </button>
          <div class="volume-slider">
            <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
          </div>
        </div>

        <div class="time-display">
          <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
        </div>

        <div class="spacer"></div>

        <div class="audio-toggle" id="audioToggle">
          <button id="subBtn" class="active">SUB</button>
          <button id="dubBtn">DUB</button>
        </div>

        <button class="control-btn" id="ccBtn" title="Subtitle Settings (C)">
          <svg viewBox="0 0 24 24"><path d="M3,3H21V5H3V3M3,7H21V9H3V7M3,11H21V13H3V11M3,15H21V17H3V15M3,19H21V21H3V19Z" style="opacity:0.7;"/><rect x="8" y="11" width="8" height="6" fill="currentColor" opacity="0.9"/></svg>
        </button>

        <div class="settings-container">
          <button class="control-btn" id="settingsBtn" title="Settings (S)">
            <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.98C19.47,12.66 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.02L21.85,9.37C22.04,9.22 22.1,8.95 21.95,8.73L19.66,5.27C19.54,5.06 19.27,5 19.05,5.12L16.56,6.07C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.07L4.95,5.12C4.73,5 4.46,5.06 4.34,5.27L2.05,8.73C1.9,8.95 1.96,9.22 2.15,9.37L4.57,11.02C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.66 4.57,12.98L2.15,14.63C1.96,14.78 1.9,15.05 2.05,15.27L4.34,18.73C4.46,18.94 4.73,19 4.95,18.88L7.44,17.93C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.93L19.05,18.88C19.27,19 19.54,18.94 19.66,18.73L21.95,15.27C22.1,15.05 22.04,14.78 21.85,14.63L19.43,12.98Z"/></svg>
          </button>
          <div class="settings-menu" id="settingsMenu">
            <div class="settings-header">
              <div class="settings-tabs">
                <button class="settings-tab-btn active" data-tab="quality" title="Quality" style="display:flex;align-items:center;justify-content:center;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M7,2H17A2,2 0 0,1 19,4V20A2,2 0 0,1 17,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2M7,4V20H17V4H7M9,6H15V8H9V6M9,10H15V12H9V10M9,14H15V16H9V14M9,18H15V20H9V18Z"/></svg></button>
                <button class="settings-tab-btn" data-tab="captions" title="Captions" style="display:flex;align-items:center;justify-content:center;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M20,4H4C2.89,4 2,4.9 2,6V18C2,19.1 2.89,20 4,20H20C21.1,20 22,19.1 22,18V6C22,4.9 21.1,4 20,4M4,12H10V14H4V12M18,14C18.55,14 19,14.45 19,15V17C19,17.55 18.55,18 18,18C17.45,18 17,17.55 17,17V15C17,14.45 17.45,14 18,14M14,14C14.55,14 15,14.45 15,15V17C15,17.55 14.55,18 14,18C13.45,18 13,17.55 13,17V15C13,14.45 13.45,14 14,14Z"/></svg></button>
                <button class="settings-tab-btn" data-tab="speed" title="Speed" style="display:flex;align-items:center;justify-content:center;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M12,2A10,10 0 1,1 2,12A10,10 0 0,1 12,2M12.5,6V12.25L17.1,14.9L16.35,16.05L11,12.9V6H12.5Z"/></svg></button>
              </div>
              <button id="closeSettingsBtn" style="background:none;border:none;color:#fff;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;"><svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:currentColor;"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button>
            </div>
            <div class="settings-content">
              <div class="settings-section active" data-section="quality" id="qualitySection"></div>
              <div class="settings-section" data-section="captions" id="captionsSection"></div>
              <div class="settings-section" data-section="speed" id="speedSection"></div>
            </div>
          </div>
        </div>

        <button class="control-btn" id="pipBtn" title="Picture in Picture (P)">
          <svg viewBox="0 0 24 24"><path d="M21,3H3C1.89,3 1,3.89 1,5V19A2,2 0 0,0 3,21H21A2,2 0 0,0 23,19V5C23,3.89 22.1,3 21,3M21,19H3V5H21M16,13H20V17H16V13Z"/></svg>
        </button>

        <button class="control-btn" id="fullscreenBtn" title="Fullscreen (F)">
          <svg viewBox="0 0 24 24" class="expand-icon"><path d="M7,14H5v5h5v-2H7V14z M5,10h2V7h3V5H5V10z M17,17h-3v2h5v-5h-2V17z M14,5v2h3v3h2V5H14z"/></svg>
          <svg viewBox="0 0 24 24" class="compress-icon" style="display:none"><path d="M5,16H8v3h2V14H5V16z M8,8H5v2h5V5H8V8z M14,19h2v-3h3v-2H14V19z M16,8V5h-2v5h5V8H16z"/></svg>
        </button>
      </div>
    </div>
    <div class="cc-modal-overlay" id="ccModal">
      <div class="cc-modal">
        <div class="cc-modal-header">
          <div class="cc-modal-title">SUBTITLE SETTINGS</div>
          <button class="cc-modal-close" id="ccModalClose"></button>
        </div>

        <div class="cc-preview" id="ccPreview">The subtitle will look like this</div>

        <div class="cc-controls">
          <div class="cc-control-group">
            <label class="cc-control-label">Font Size</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="range" class="cc-slider" id="fontSizeSlider" min="10" max="32" value="16">
              <span class="cc-slider-value" id="fontSizeValue">16px</span>
            </div>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Font Color</label>
            <div class="cc-color-picker" id="fontColorPicker"></div>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Text Opacity</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="range" class="cc-slider" id="textOpacitySlider" min="0" max="100" value="100">
              <span class="cc-slider-value" id="textOpacityValue">100%</span>
            </div>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Font Name</label>
            <select class="cc-dropdown" id="fontFamilySelect">
              <option>Arial</option>
              <option>Arial Black</option>
              <option>Courier New</option>
              <option>Georgia</option>
              <option>Impact</option>
              <option>Lucida Console</option>
              <option>Tahoma</option>
              <option>Times New Roman</option>
              <option>Trebuchet MS</option>
            </select>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Background Color</label>
            <div class="cc-color-picker" id="bgColorPicker"></div>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Background Opacity</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="range" class="cc-slider" id="bgOpacitySlider" min="0" max="100" value="0">
              <span class="cc-slider-value" id="bgOpacityValue">0%</span>
            </div>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Subtitle Shadow</label>
            <select class="cc-dropdown" id="shadowSelect">
              <option value="none">None</option>
              <option value="drop-shadow">Drop Shadow</option>
              <option value="outer-shade">Outer Shade</option>
              <option value="top-shadow">Top Shadow</option>
              <option value="edge-shadow" selected>Edge Shadow</option>
            </select>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Window Color</label>
            <div class="cc-color-picker" id="windowColorPicker"></div>
          </div>

          <div class="cc-control-group">
            <label class="cc-control-label">Window Opacity</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="range" class="cc-slider" id="windowOpacitySlider" min="0" max="100" value="0">
              <span class="cc-slider-value" id="windowOpacityValue">0%</span>
            </div>
          </div>
        </div>

        <div class="cc-buttons">
          <button class="cc-btn cc-btn-reset" id="ccResetBtn">Reset</button>
          <button class="cc-btn cc-btn-save" id="ccSaveBtn">Save Settings</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const playerWrapper = document.getElementById('playerWrapper');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const errorOverlay = document.getElementById('errorOverlay');
    const errorText = document.getElementById('errorText');

    const playPauseBtn = document.getElementById('playPauseBtn');
    const playPauseMain = document.getElementById('playPauseMain');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const pipBtn = document.getElementById('pipBtn');

    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressBuffered = document.getElementById('progressBuffered');
    const progressHandle = document.getElementById('progressHandle');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');

    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const qualitySection = document.getElementById('qualitySection');
    const captionsSection = document.getElementById('captionsSection');
    const speedSection = document.getElementById('speedSection');

    const ccBtn = document.getElementById('ccBtn');
    const ccModal = document.getElementById('ccModal');
    const ccModalClose = document.getElementById('ccModalClose');
    const ccPreview = document.getElementById('ccPreview');
    const fontSizeSlider = document.getElementById('fontSizeSlider');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const textOpacitySlider = document.getElementById('textOpacitySlider');
    const textOpacityValue = document.getElementById('textOpacityValue');
    const bgOpacitySlider = document.getElementById('bgOpacitySlider');
    const bgOpacityValue = document.getElementById('bgOpacityValue');
    const windowOpacitySlider = document.getElementById('windowOpacitySlider');
    const windowOpacityValue = document.getElementById('windowOpacityValue');
    const fontFamilySelect = document.getElementById('fontFamilySelect');
    const shadowSelect = document.getElementById('shadowSelect');
    const ccResetBtn = document.getElementById('ccResetBtn');
    const ccSaveBtn = document.getElementById('ccSaveBtn');

    const ccColors = ['#000000', '#0000FF', '#00FF00', '#00FFFF', '#FF0000', '#FF00FF', '#FFFF00', '#0099FF'];
    const ccDefaults = {
      fontSize: 16,
      fontColor: '#FFFFFF',
      textOpacity: 100,
      fontFamily: 'Arial',
      bgColor: '#000000',
      bgOpacity: 0,
      shadow: 'edge-shadow',
      windowColor: '#000000',
      windowOpacity: 0
    };

    const subBtn = document.getElementById('subBtn');
    const dubBtn = document.getElementById('dubBtn');
    const skipIntro = document.getElementById('skipIntro');
    const skipOutro = document.getElementById('skipOutro');

    const rewindBtn = document.getElementById('rewindBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const seekLeft = document.getElementById('seekLeft');
    const seekRight = document.getElementById('seekRight');

    let hls = null;
    let streamData = null;
    let currentAudioType = 'sub';
    let controlsTimeout = null;
    let introEnd = 0;
    let outroStart = 0;
    let outroEnd = 0;
    let thumbnailData = null;
    let thumbnailImg = new Image();
    const playbackSpeeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2];

    async function loadThumbnails(tracks) {
      const thumbnailTrack = tracks.find(t => t.kind === 'thumbnails');
      if (!thumbnailTrack) return;

      try {
        const vttUrl = thumbnailTrack.file;
        const response = await fetch(proxyUrl(vttUrl));
        const vttText = await response.text();
        const lines = vttText.split('\n');
        
        const vttBaseUrl = vttUrl.substring(0, vttUrl.lastIndexOf('/') + 1);
        
        thumbnailData = [];
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.includes('-->')) {
            const timeParts = line.split('-->');
            const startTime = timeToSeconds(timeParts[0].trim());
            const endTime = timeToSeconds(timeParts[1].trim());
            
            if (i + 1 < lines.length) {
              const nextLine = lines[i + 1].trim();
              if (nextLine.includes('#xywh=')) {
                const match = nextLine.match(/#xywh=(\d+),(\d+),(\d+),(\d+)/);
                if (match) {
                  let spriteUrl = nextLine.split('#')[0];
                  if (!spriteUrl.startsWith('http')) {
                    spriteUrl = vttBaseUrl + spriteUrl;
                  }
                  thumbnailData.push({
                    start: startTime,
                    end: endTime,
                    url: spriteUrl,
                    x: parseInt(match[1]),
                    y: parseInt(match[2]),
                    width: parseInt(match[3]),
                    height: parseInt(match[4])
                  });
                }
              }
            }
          }
        }
        
        console.log('Loaded', thumbnailData.length, 'thumbnail frames');
      } catch (error) {
        console.error('Failed to load thumbnails:', error);
      }
    }

    function timeToSeconds(timeStr) {
      const parts = timeStr.split(':');
      let seconds = 0;
      if (parts.length === 3) {
        seconds += parseInt(parts[0]) * 3600;
        seconds += parseInt(parts[1]) * 60;
        seconds += parseFloat(parts[2]);
      } else if (parts.length === 2) {
        seconds += parseInt(parts[0]) * 60;
        seconds += parseFloat(parts[1]);
      }
      return seconds;
    }

    function getThumbnailAtTime(time) {
      if (!thumbnailData || thumbnailData.length === 0) return null;
      return thumbnailData.find(t => time >= t.start && time < t.end);
    }

    function proxyUrl(url) {
      if (!url || url.startsWith('/proxy?url=')) return url;
      return '/proxy?url=' + encodeURIComponent(url);
    }

    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      if (hrs > 0) {
        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function getIdFromUrl() {
      const path = window.location.pathname;
      const match = path.match(/\/embed\/(.+)/);
      return match ? decodeURIComponent(match[1]) : null;
    }

    function showLoading(show) {
      loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    function showError(message) {
      errorText.textContent = message;
      errorOverlay.style.display = 'flex';
      showLoading(false);
    }

    function updatePlayPauseIcons() {
      const paused = video.paused;
      document.querySelectorAll('.play-icon').forEach(el => el.style.display = paused ? 'block' : 'none');
      document.querySelectorAll('.pause-icon').forEach(el => el.style.display = paused ? 'none' : 'block');
    }

    function updateVolumeIcon() {
      const muted = video.muted || video.volume === 0;
      document.querySelector('.volume-high').style.display = muted ? 'none' : 'block';
      document.querySelector('.volume-muted').style.display = muted ? 'block' : 'none';
    }

    function updateProgress() {
      if (video.duration) {
        const percent = (video.currentTime / video.duration) * 100;
        progressBar.style.width = percent + '%';
        progressHandle.style.left = percent + '%';
        currentTimeEl.textContent = formatTime(video.currentTime);
      }
    }

    function updateBuffered() {
      if (video.buffered.length > 0) {
        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
        const percent = (bufferedEnd / video.duration) * 100;
        progressBuffered.style.width = percent + '%';
      }
    }

    function showControls() {
      playerWrapper.classList.add('show-controls');
      clearTimeout(controlsTimeout);
      if (!video.paused) {
        controlsTimeout = setTimeout(() => {
          playerWrapper.classList.remove('show-controls');
        }, 3000);
      }
    }

    function checkSkipButtons() {
      const currentTime = video.currentTime;
      if (introEnd > 0 && currentTime < introEnd) {
        skipIntro.classList.add('show');
      } else {
        skipIntro.classList.remove('show');
      }
      if (outroStart > 0 && currentTime >= outroStart && currentTime < outroEnd) {
        skipOutro.style.display = 'block';
        skipOutro.classList.add('show');
      } else {
        skipOutro.classList.remove('show');
      }
    }

    function clearSubtitles() {
      video.querySelectorAll('track[kind="subtitles"]').forEach(t => t.remove());
    }

    function populateSubtitles(tracks) {
      captionsSection.innerHTML = '<div class="settings-option active" data-value=""><span>Off</span><span class="check">✓</span></div>';
      const captionTracks = tracks.filter(t => t.kind === 'captions');
      captionTracks.forEach(track => {
        const option = document.createElement('div');
        option.className = 'settings-option';
        option.dataset.value = track.file;
        option.innerHTML = `<span>${track.label}</span><span class="check">✓</span>`;
        if (track.default) {
          option.classList.add('active');
          captionsSection.querySelector('[data-value=""]').classList.remove('active');
          loadSubtitle(track.file);
        }
        captionsSection.appendChild(option);
      });
      populatePlaybackSpeeds();
    }

    function loadSubtitle(url) {
      clearSubtitles();
      if (url) {
        const track = document.createElement('track');
        track.kind = 'subtitles';
        track.src = proxyUrl(url);
        track.srclang = 'en';
        track.default = true;
        video.appendChild(track);
        track.track.mode = 'showing';
      }
    }

    function populateQualityLevels() {
      if (!hls) return;
      qualitySection.innerHTML = '<div class="settings-option active" data-value="-1"><span>Auto</span><span class="check">✓</span></div>';
      hls.levels.forEach((level, index) => {
        const option = document.createElement('div');
        option.className = 'settings-option';
        option.dataset.value = index;
        option.innerHTML = `<span>${level.height}p</span><span class="check">✓</span>`;
        qualitySection.appendChild(option);
      });
    }

    function populatePlaybackSpeeds() {
      speedSection.innerHTML = '';
      playbackSpeeds.forEach(speed => {
        const option = document.createElement('div');
        option.className = 'settings-option' + (video.playbackRate === speed ? ' active' : '');
        option.dataset.value = speed;
        option.innerHTML = `<span>${speed === 1 ? '1x' : speed + 'x'}</span><span class="check">✓</span>`;
        speedSection.appendChild(option);
      });
    }

    async function loadStream(audioType) {
      if (!streamData) return;
      const source = audioType === 'dub' ? streamData.dub : streamData.sub;
      if (!source || !source.link) {
        showError('Stream not available');
        return;
      }

      showLoading(true);
      clearSubtitles();
      const currentTime = video.currentTime;

      if (hls) {
        hls.destroy();
        hls = null;
      }

      introEnd = source.intro?.end || 0;
      outroStart = source.outro?.start || 0;
      outroEnd = source.outro?.end || 0;

      const streamUrl = typeof source.link === 'string' ? source.link : source.link?.file;
      if (!streamUrl) {
        showError('Stream URL not available');
        return;
      }
      const hlsUrl = proxyUrl(streamUrl);

      if (Hls.isSupported()) {
        hls = new Hls({
          debug: false,
          enableWorker: true,
          lowLatencyMode: false,
          manifestLoadPolicy: {
            default: {
              maxTimeToFirstByteMs: 10000,
              maxLoadTimeMs: 20000,
              timeoutRetry: { maxNumRetry: 3, retryDelayMs: 0, maxRetryDelayMs: 0 },
              errorRetry: { maxNumRetry: 3, retryDelayMs: 1000, maxRetryDelayMs: 8000 }
            }
          },
          fragLoadPolicy: {
            default: {
              maxTimeToFirstByteMs: 10000,
              maxLoadTimeMs: 120000,
              timeoutRetry: { maxNumRetry: 4, retryDelayMs: 0, maxRetryDelayMs: 0 },
              errorRetry: { maxNumRetry: 6, retryDelayMs: 1000, maxRetryDelayMs: 8000 }
            }
          }
        });

        hls.loadSource(hlsUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          showLoading(false);
          populateQualityLevels();
          const subtitleTracks = audioType === 'dub' ? (streamData.sub?.tracks || []) : (source.tracks || []);
          populateSubtitles(subtitleTracks);
          loadThumbnails(source.tracks || []);
          if (currentTime > 0) {
            video.currentTime = currentTime;
          }
          video.play().catch(() => {});
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error('HLS Error:', data);
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hls.recoverMediaError();
                break;
              default:
                showError('Playback error: ' + data.details);
                break;
            }
          }
        });

        hls.on(Hls.Events.FRAG_LOADED, () => {
          showLoading(false);
        });

      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = hlsUrl;
        video.addEventListener('loadedmetadata', () => {
          showLoading(false);
          const subtitleTracks = audioType === 'dub' ? (streamData.sub?.tracks || []) : (source.tracks || []);
          populateSubtitles(subtitleTracks);
          loadThumbnails(source.tracks || []);
          if (currentTime > 0) {
            video.currentTime = currentTime;
          }
          video.play().catch(() => {});
        }, { once: true });
      } else {
        showError('HLS not supported in this browser');
      }
    }

    async function init() {
      const id = getIdFromUrl();
      if (!id) {
        showError('No video ID provided');
        return;
      }

      try {
        const response = await fetch('/api/stream?id=' + encodeURIComponent(id));
        const result = await response.json();

        if (!result.success) {
          showError('Failed to load stream data');
          return;
        }

        streamData = result.data;
        loadStream(currentAudioType);

      } catch (error) {
        console.error('Init error:', error);
        showError('Error: ' + error.message);
      }
    }

    playPauseBtn.addEventListener('click', () => {
      video.paused ? video.play() : video.pause();
    });

    playPauseMain.addEventListener('click', () => {
      video.paused ? video.play() : video.pause();
    });

    volumeBtn.addEventListener('click', () => {
      video.muted = !video.muted;
      updateVolumeIcon();
    });

    volumeSlider.addEventListener('input', () => {
      video.volume = volumeSlider.value;
      video.muted = false;
      updateVolumeIcon();
    });

    fullscreenBtn.addEventListener('click', () => {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        playerWrapper.requestFullscreen();
      }
    });

    document.addEventListener('fullscreenchange', () => {
      const isFs = !!document.fullscreenElement;
      document.querySelector('.expand-icon').style.display = isFs ? 'none' : 'block';
      document.querySelector('.compress-icon').style.display = isFs ? 'block' : 'none';
    });

    pipBtn.addEventListener('click', async () => {
      if (document.pictureInPictureElement) {
        await document.exitPictureInPicture();
      } else if (video.requestPictureInPicture) {
        await video.requestPictureInPicture();
      }
    });

    rewindBtn.addEventListener('click', () => {
      video.currentTime = Math.max(0, video.currentTime - 10);
      seekLeft.style.display = 'block';
      setTimeout(() => seekLeft.style.display = 'none', 500);
    });

    forwardBtn.addEventListener('click', () => {
      video.currentTime = Math.min(video.duration, video.currentTime + 10);
      seekRight.style.display = 'block';
      setTimeout(() => seekRight.style.display = 'none', 500);
    });

    progressContainer.addEventListener('click', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      video.currentTime = percent * video.duration;
    });

    progressContainer.addEventListener('mousemove', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const time = percent * video.duration;
      
      const thumbnail = getThumbnailAtTime(time);
      if (thumbnail) {
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        const thumbnailTimeEl = document.getElementById('thumbnailTime');
        const thumbnailImgEl = document.getElementById('thumbnailImg');
        
        thumbnailImgEl.style.backgroundImage = `url('${proxyUrl(thumbnail.url)}')`;
        thumbnailImgEl.style.backgroundPosition = `-${thumbnail.x}px -${thumbnail.y}px`;
        thumbnailImgEl.style.backgroundRepeat = 'no-repeat';
        thumbnailImgEl.style.backgroundSize = 'auto';
        
        let displayWidth = thumbnail.width;
        let displayHeight = thumbnail.height;
        
        if (window.innerWidth <= 600) {
          displayWidth = Math.min(thumbnail.width, 120);
          displayHeight = Math.min(thumbnail.height, 68);
        } else if (window.innerWidth <= 768) {
          displayWidth = Math.min(thumbnail.width, 140);
          displayHeight = Math.min(thumbnail.height, 79);
        }
        
        thumbnailImgEl.style.width = displayWidth + 'px';
        thumbnailImgEl.style.height = displayHeight + 'px';
        
        thumbnailTimeEl.textContent = formatTime(time);
        
        let previewLeft = e.clientX - rect.left - displayWidth / 2;
        previewLeft = Math.max(0, Math.min(previewLeft, rect.width - displayWidth));
        thumbnailPreview.style.left = previewLeft + 'px';
        thumbnailPreview.style.transform = 'none';
        thumbnailPreview.style.display = 'flex';
      }
    });

    progressContainer.addEventListener('mouseleave', () => {
      const thumbnailPreview = document.getElementById('thumbnailPreview');
      thumbnailPreview.style.display = 'none';
    });

    let isDragging = false;
    progressContainer.addEventListener('mousedown', () => isDragging = true);
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const rect = progressContainer.getBoundingClientRect();
        const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        video.currentTime = percent * video.duration;
      }
    });

    subBtn.addEventListener('click', () => {
      if (currentAudioType !== 'sub') {
        currentAudioType = 'sub';
        subBtn.classList.add('active');
        dubBtn.classList.remove('active');
        loadStream('sub');
      }
    });

    dubBtn.addEventListener('click', () => {
      if (currentAudioType !== 'dub') {
        currentAudioType = 'dub';
        dubBtn.classList.add('active');
        subBtn.classList.remove('active');
        loadStream('dub');
      }
    });

    skipIntro.addEventListener('click', () => {
      video.currentTime = introEnd;
    });

    skipOutro.addEventListener('click', () => {
      video.currentTime = outroEnd;
    });

    settingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsMenu.classList.toggle('show');
    });

    closeSettingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsMenu.classList.remove('show');
    });

    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const tabName = btn.dataset.tab;
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        btn.classList.add('active');
        document.querySelector(`[data-section="${tabName}"]`).classList.add('active');
      });
    });

    settingsMenu.addEventListener('click', (e) => {
      const option = e.target.closest('.settings-option');
      if (option) {
        const section = option.closest('.settings-section');
        if (section.id === 'qualitySection') {
          qualitySection.querySelectorAll('.settings-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          const level = parseInt(option.dataset.value);
          if (hls) hls.currentLevel = level;
        } else if (section.id === 'captionsSection') {
          captionsSection.querySelectorAll('.settings-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          loadSubtitle(option.dataset.value);
        } else if (section.id === 'speedSection') {
          speedSection.querySelectorAll('.settings-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          video.playbackRate = parseFloat(option.dataset.value);
        }
      }
    });

    function createColorPickers() {
      const pickers = [
        { id: 'fontColorPicker', active: '#FFFFFF' },
        { id: 'bgColorPicker', active: '#000000' },
        { id: 'windowColorPicker', active: '#000000' }
      ];
      pickers.forEach(picker => {
        const container = document.getElementById(picker.id);
        ccColors.forEach(color => {
          const btn = document.createElement('button');
          btn.className = 'cc-color-btn' + (color === picker.active ? ' active' : '');
          btn.style.backgroundColor = color;
          btn.dataset.color = color;
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            container.querySelectorAll('.cc-color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (picker.id === 'fontColorPicker') {
              document.documentElement.style.setProperty('--cc-text-color', color);
              ccPreview.style.color = color;
            } else if (picker.id === 'bgColorPicker') {
              document.documentElement.style.setProperty('--cc-bg-color', color);
            } else {
              document.documentElement.style.setProperty('--cc-window-color', color);
            }
          });
          container.appendChild(btn);
        });
      });
    }

    function updateCCPreview() {
      ccPreview.style.fontSize = fontSizeSlider.value + 'px';
      ccPreview.style.opacity = textOpacitySlider.value / 100;
      ccPreview.style.fontFamily = fontFamilySelect.value;
    }

    fontSizeSlider.addEventListener('input', () => {
      fontSizeValue.textContent = fontSizeSlider.value + 'px';
      document.documentElement.style.setProperty('--cc-font-size', fontSizeSlider.value + 'px');
      updateCCPreview();
    });

    textOpacitySlider.addEventListener('input', () => {
      textOpacityValue.textContent = textOpacitySlider.value + '%';
      document.documentElement.style.setProperty('--cc-text-opacity', textOpacitySlider.value / 100);
      updateCCPreview();
    });

    bgOpacitySlider.addEventListener('input', () => {
      bgOpacityValue.textContent = bgOpacitySlider.value + '%';
      document.documentElement.style.setProperty('--cc-bg-opacity', bgOpacitySlider.value / 100);
    });

    windowOpacitySlider.addEventListener('input', () => {
      windowOpacityValue.textContent = windowOpacitySlider.value + '%';
      document.documentElement.style.setProperty('--cc-window-opacity', windowOpacitySlider.value / 100);
    });

    fontFamilySelect.addEventListener('change', () => {
      document.documentElement.style.setProperty('--cc-font-family', fontFamilySelect.value);
      updateCCPreview();
    });

    ccBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      ccModal.classList.add('show');
    });

    ccModalClose.addEventListener('click', (e) => {
      e.stopPropagation();
      ccModal.classList.remove('show');
    });

    ccResetBtn.addEventListener('click', () => {
      fontSizeSlider.value = ccDefaults.fontSize;
      textOpacitySlider.value = ccDefaults.textOpacity;
      bgOpacitySlider.value = ccDefaults.bgOpacity;
      windowOpacitySlider.value = ccDefaults.windowOpacity;
      fontFamilySelect.value = ccDefaults.fontFamily;
      shadowSelect.value = ccDefaults.shadow;
      fontSizeValue.textContent = ccDefaults.fontSize + 'px';
      textOpacityValue.textContent = ccDefaults.textOpacity + '%';
      bgOpacityValue.textContent = ccDefaults.bgOpacity + '%';
      windowOpacityValue.textContent = ccDefaults.windowOpacity + '%';
      document.documentElement.style.setProperty('--cc-font-size', ccDefaults.fontSize + 'px');
      document.documentElement.style.setProperty('--cc-text-opacity', ccDefaults.textOpacity / 100);
      document.documentElement.style.setProperty('--cc-bg-opacity', ccDefaults.bgOpacity / 100);
      document.documentElement.style.setProperty('--cc-window-opacity', ccDefaults.windowOpacity / 100);
      updateCCPreview();
    });

    ccSaveBtn.addEventListener('click', () => {
      ccModal.classList.remove('show');
    });

    ccModal.addEventListener('click', (e) => {
      if (e.target === ccModal) {
        ccModal.classList.remove('show');
      }
    });

    document.addEventListener('click', () => {
      settingsMenu.classList.remove('show');
    });

    createColorPickers();

    video.addEventListener('play', updatePlayPauseIcons);
    video.addEventListener('pause', updatePlayPauseIcons);
    video.addEventListener('volumechange', updateVolumeIcon);
    video.addEventListener('timeupdate', () => {
      updateProgress();
      checkSkipButtons();
    });
    video.addEventListener('progress', updateBuffered);
    video.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(video.duration);
    });
    video.addEventListener('waiting', () => showLoading(true));
    video.addEventListener('canplay', () => showLoading(false));

    playerWrapper.addEventListener('mousemove', showControls);
    playerWrapper.addEventListener('click', showControls);

    let lastTapLeft = 0;
    let lastTapRight = 0;

    function handleDoubleTapLeft(e) {
      e.preventDefault();
      const now = Date.now();
      if (now - lastTapLeft < 300) {
        video.currentTime = Math.max(0, video.currentTime - 10);
        seekLeft.style.display = 'block';
        setTimeout(() => seekLeft.style.display = 'none', 500);
        lastTapLeft = 0;
      } else {
        lastTapLeft = now;
      }
    }

    function handleDoubleTapRight(e) {
      e.preventDefault();
      const now = Date.now();
      if (now - lastTapRight < 300) {
        video.currentTime = Math.min(video.duration, video.currentTime + 10);
        seekRight.style.display = 'block';
        setTimeout(() => seekRight.style.display = 'none', 500);
        lastTapRight = 0;
      } else {
        lastTapRight = now;
      }
    }

    const doubleTapLeftEl = document.getElementById('doubleTapLeft');
    const doubleTapRightEl = document.getElementById('doubleTapRight');

    doubleTapLeftEl.addEventListener('click', handleDoubleTapLeft);
    doubleTapLeftEl.addEventListener('touchend', handleDoubleTapLeft);
    doubleTapRightEl.addEventListener('click', handleDoubleTapRight);
    doubleTapRightEl.addEventListener('touchend', handleDoubleTapRight);

    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT') return;

      switch (e.key.toLowerCase()) {
        case ' ':
        case 'k':
          e.preventDefault();
          video.paused ? video.play() : video.pause();
          break;
        case 'f':
          e.preventDefault();
          fullscreenBtn.click();
          break;
        case 'm':
          e.preventDefault();
          video.muted = !video.muted;
          break;
        case 'arrowleft':
          e.preventDefault();
          video.currentTime = Math.max(0, video.currentTime - 5);
          break;
        case 'arrowright':
          e.preventDefault();
          video.currentTime = Math.min(video.duration, video.currentTime + 5);
          break;
        case 'arrowup':
          e.preventDefault();
          video.volume = Math.min(1, video.volume + 0.1);
          break;
        case 'arrowdown':
          e.preventDefault();
          video.volume = Math.max(0, video.volume - 0.1);
          break;
        case 'c':
          e.preventDefault();
          subtitlesBtn.click();
          break;
        case 'p':
          e.preventDefault();
          pipBtn.click();
          break;
        case 'j':
          e.preventDefault();
          video.currentTime = Math.max(0, video.currentTime - 10);
          break;
        case 'l':
          e.preventDefault();
          video.currentTime = Math.min(video.duration, video.currentTime + 10);
          break;
        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
          e.preventDefault();
          video.currentTime = (parseInt(e.key) / 10) * video.duration;
          break;
      }
      showControls();
    });

    init();
  </script>
</body>
</html>
